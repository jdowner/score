<!DOCTYPE html>
<html>
  <head>
    <title>drum-music-app</title>
  </head>
  <script src="raphael-v2.1.2-min.js"></script>
  <script src="underscore-v1.5.2-min.js"></script>
  <script src="vexflow-min.js"></script>
  <body>
    <svg id="score" width="800" height="1000"></svg>
  </body>
  <script>
    var Renderer = function(id) {
      canvas = document.getElementById(id)
      this.renderer = new Vex.Flow.Renderer(canvas, Vex.Flow.Renderer.Backends.RAPHAEL)
      this.ctx = this.renderer.getContext()
    }

    Renderer.prototype.clear = function() {
      this.ctx.clear()
    }

    Renderer.prototype.draw_stave = function(x, y, in_stave) {
      // Create new vexflow stave object
      var stave = new Vex.Flow.Stave(x, y, in_stave.width);

//      // Add a clef if this stave has one
//      if(in_stave.clef) {
//        stave.addClef(in_stave.clef)
//      }
//      
//      // Add a time signature if there is one
//      if(in_stave.signature) {
//        stave.addTimeSignature(in_stave.signature)
//      }
//
//      if(in_stave.end_bar) {
//        stave.setEndBarType(Vex.Flow.Barline.type.END)
//      }

      stave.setContext(this.ctx)
      stave.draw()

      // Create a voice
      var voice = new Vex.Flow.Voice({
        num_beats: 4,
        beat_value: 4,
        resolution: Vex.Flow.RESOLUTION
      });

      // Add notes to the voice
      voice.addTickables(in_stave.notes);

      // Format and justify the notes
      var formatter = new Vex.Flow.Formatter()
      formatter.joinVoices([voice])
      formatter.format([voice], in_stave.width)
      formatter.formatToStave([voice], stave)

      // Draw the voice
      voice.draw(this.ctx, stave);
    }

    Renderer.prototype.draw_score = function(score) {
      for(var i = 0; i < score.staves.length; i++) {
        this.draw_stave(10, 100 * i, score.staves[i])
      }
    }

    function make_note(name) {
      return new Vex.Flow.StaveNote({ keys: ["c/5"], duration: name})
    }

    function make_notes(str) {
      var notes = new Array()
      var str_notes = str.split(" ")
      for(var i = 0; i < str_notes.length; i++) {
        notes.push(this.make_note(str_notes[i]))
      }
      return notes
    }

    var Stave = function(notes) {
      this.width = 300
      this.notes = make_notes(notes)
    }

    Stave.prototype.notes = function() {
      return this.notes
    }

    var Score = function() {
      this.clef = "percussion"
      this.signature = "4/4"

      this.staves = new Array()
      this.staves.push(new Stave('8 8r 8 4 16 16 8 8'))
      this.staves.push(new Stave('8 16r 16 8 4 16 16 8 8'))
      this.staves.push(new Stave('4 4 4 4'))
      this.staves.push(new Stave('8 8r 8 4 16 16 8 8'))
      this.staves.push(new Stave('8 16r 16 8 4 16 16 8 8'))
      this.staves.push(new Stave('4 4 4 4'))
      this.staves.push(new Stave('8 8r 8 4 16 16 8 8'))
      this.staves.push(new Stave('8 16r 16 8 4 16 16 8 8'))
      this.staves.push(new Stave('4 4 4 4'))
    }

    Score.prototype.clef = function() {
      return this.clef
    }

    Score.prototype.signature = function() {
      return this.signature
    }

    Score.prototype.shuffle = function() {
      this.staves = _.shuffle(this.staves)
    }

    var score = new Score()
    var renderer = new Renderer("score")

    function update() {
      renderer.clear()
      renderer.draw_score(score)
    }

    function order() {
    }

    function init() {
      update()

      var svg = document.getElementById("score")
      svg.addEventListener('click', function(e) {
        score.shuffle()
        update()
      })
    }

    window.addEventListener('load', init, false)
  </script>
</html>
